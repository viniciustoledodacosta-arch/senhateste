V77.7
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Guichê - Painel de Senhas</title>
  <style>
    :root {
      --verde-hcpa: #276e5b;
      --amarelo-hcpa: #ffe900;
      --preto: #000;
      --tom-agendar: #d70000;
      --tom-realizar: #0074d9;
      --cinza-texto: #fffbe5;
    }

    body {
      background: var(--verde-hcpa);
      color: var(--amarelo-hcpa);
      font-family: Arial, Helvetica, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: var(--preto);
      border-radius: 15px;
      padding: 36px 40px;
      box-shadow: 0 0 12px #0007;
      text-align: center;
      min-width: 350px;
      max-width: 650px;
      margin: auto;
    }
    .titulo {
      font-size: 2.2em;
      color: var(--amarelo-hcpa);
      margin-bottom: 18px;
      font-weight: bold;
      letter-spacing: 1px;
    }
    label, input, select { font-size: 1.2em; margin: 4px 0; }
    input, select {
      padding: 6px;
      border-radius: 6px;
      border: none;
      margin-bottom: 14px;
      width: 80%;
      box-sizing: border-box;
    }
    .botao {
      background: var(--amarelo-hcpa);
      color: var(--preto);
      border: none;
      border-radius: 8px;
      font-size: 1.25em;
      padding: 12px 24px;
      margin: 10px 8px 10px 0;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .botao:hover { filter: brightness(0.95); }

    .agendar-btn {
      background: var(--tom-agendar);
      color: #fff;
    }
    .agendar-btn:hover { filter: brightness(0.9); }

    .realizar-btn {
      background: var(--tom-realizar);
      color: #fff;
    }
    .realizar-btn:hover { filter: brightness(0.9); }

    .senha-form { margin-bottom: 22px; }

    .admin-btn {
      margin-top: 24px;
      background: var(--verde-hcpa);
      color: var(--amarelo-hcpa);
      font-weight: bold;
      border-radius: 8px;
      padding: 8px 22px;
      border: none;
      cursor: pointer;
      font-size: 1.1em;
      transition: background 0.2s, filter 0.2s;
    }
    .admin-btn:hover { background: #1f5a48; filter: brightness(1.02); }

    /* área de senhas chamadas (histórico global, exibido ao usuário logado) */
    .chamadas-area {
      margin-top: 18px;
      text-align: left;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
      color: #ffe900;
    }
    .chamadas-area .titulo-ch { font-weight: bold; margin-bottom: 8px; }
    .lista-chamadas {
      list-style: none;
      padding: 6px;
      margin: 0;
      background: #111;
      border-radius: 8px;
      max-height: 260px;
      overflow-y: auto;
      box-shadow: inset 0 0 6px #0008;
    }
    .lista-chamadas li {
      display: flex;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #ffe90022;
      font-size: 1em;
      align-items: center;
      gap: 8px;
    }
    .lista-chamadas li:last-child { border-bottom: none; }
    .lista-chamadas .left { display:flex; flex-direction:column; }
    .lista-chamadas .senha { font-weight: bold; font-size: 1.05em; color: #fffbe5; }
    .lista-chamadas .tipo { font-size: 0.9em; opacity: 0.85; color: #ffe900cc; }
    .lista-chamadas .guiche { font-weight: bold; color: #fffbe5; }

    .admin-area {
      background: #222;
      border-radius: 10px;
      padding: 24px 22px;
      color: #ffe900;
      font-size: 1.15em;
      box-shadow: 0 0 8px #0004;
      margin-top: 18px;
      display: none;
      text-align: left;
      margin-left: auto;
      margin-right: auto;
      max-width: 420px;
    }

    .relatorio-area {
      background: #222;
      border-radius: 10px;
      padding: 22px;
      color: #ffe900;
      font-size: 1.03em;
      margin-top: 14px;
      box-shadow: 0 0 8px #0004;
      display: none;
      max-width: 600px;
      overflow-x: auto;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }

    .aba-btn {
      background: #276e5b;
      color: #ffe900;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 8px;
      margin-bottom: 9px;
      transition: background 0.2s;
    }
    .aba-btn.active { background: #ffe900; color: #276e5b; }
    .excel-btn {
      background: #4caf50;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 18px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 8px;
      margin-bottom: 9px;
      font-size: 1em;
      transition: background 0.2s;
    }
    .excel-btn:hover { background: #1b5e20; }

    @media (max-width: 700px) {
      .container, .admin-area, .relatorio-area { min-width: 95vw; max-width: 97vw; padding-left: 4vw; padding-right: 4vw;}
      .chamadas-area { max-width: 95vw; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container" id="guiche-container" style="display:none;">
    <div class="titulo">Guichê</div>
    <div id="usuarioLogado" style="color:#fffbe5;margin-bottom:12px;font-size:1.1em;"></div>
    <label for="guicheNum">Número do Guichê:</label>
    <input type="number" id="guicheNum" min="1" max="20" value="1" required><br>

    <button class="botao agendar-btn" onclick="chamarSenhaDireto('Agendar')">Senha Agendar</button>
    <button class="botao realizar-btn" onclick="chamarSenhaDireto('Agendados')">Senha Realizar</button>
    <button class="botao" onclick="chamarSenha('repetir')">Rechamar</button>
    <div id="msg" style="color:yellow;margin-top:10px;"></div>

    <button class="admin-btn" onclick="abrirAdmin()">Administração</button>
    <button class="admin-btn" onclick="abrirRelatorio()">Relatórios</button>

    <!-- área: Senhas Chamadas (histórico global, similar ao painel) -->
    <div class="chamadas-area" id="chamadasArea" style="display:none;">
      <div class="titulo-ch">Senhas Chamadas</div>
      <ul id="listaSenhasChamadas" class="lista-chamadas"></ul>
    </div>

    <div id="adminArea" class="admin-area"></div>
    <div id="relatorioArea" class="relatorio-area"></div>
  </div>

  <div id="senha-protect" class="senha-form">
    <label for="usuario">Usuário:</label>
    <input type="text" id="usuario" autofocus>
    <br>
    <label for="senha">Senha de acesso:</label>
    <input type="password" id="senha">
    <button onclick="checarLogin()">Entrar</button>
    <div id="msgSenha" style="color:red;margin-top:8px;"></div>
  </div>

  <script>
    const senhaCorreta = "radiologia2025";
    const usuarioAdmin = "vtcosta";
    const senhaAdmin = "admtoledo";

    let usuariosAutorizados = [];
    let usuarioLogado = null;
    let isAdmin = false;

    const firebaseConfig = {
      apiKey: "AIzaSyB-wxIiE1o4SlwhIAowvzDoP2MTCwHeUA8",
      authDomain: "senha-teste-3792a.firebaseapp.com",
      databaseURL: "https://senha-teste-3792a-default-rtdb.firebaseio.com",
      projectId: "senha-teste-3792a",
      storageBucket: "senha-teste-3792a.appspot.com",
      messagingSenderId: "748802844835",
      appId: "1:748802844835:web:443305d871158d21ab7716",
      measurementId: "G-P6PCN541CD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref("usuariosAutorizados").on("value", snap => {
      usuariosAutorizados = snap.val() || [];
    });

    let contadores = {
      Agendar: 0,
      Agendados: 0
    };
    let historicoGuiche = {};

    db.ref("contadoresSenha").once("value", snap => {
      const val = snap.val();
      if(val) contadores = val;
    });

    function checarLogin() {
      const usuario = document.getElementById("usuario").value.trim();
      const senhaInput = document.getElementById("senha").value;
      let msg = document.getElementById("msgSenha");

      if (usuario === usuarioAdmin && senhaInput === senhaAdmin) {
        usuarioLogado = usuarioAdmin;
        isAdmin = true;
        document.getElementById("senha-protect").style.display = "none";
        document.getElementById("guiche-container").style.display = "block";
        document.getElementById("usuarioLogado").textContent = "Usuário admin: " + usuarioLogado;
        msg.textContent = "";
        iniciarHistoricoChamadas();
        return;
      }
      if (usuariosAutorizados.includes(usuario) && senhaInput === senhaCorreta) {
        usuarioLogado = usuario;
        isAdmin = false;
        document.getElementById("senha-protect").style.display = "none";
        document.getElementById("guiche-container").style.display = "block";
        document.getElementById("usuarioLogado").textContent = "Usuário: " + usuarioLogado;
        msg.textContent = "";
        iniciarHistoricoChamadas();
        return;
      }
      msg.textContent = "Usuário ou senha incorretos!";
    }

    // Listener global para atualizar a lista de chamadas (últimas 8)
    let _histChamadasRef = null;
    function iniciarHistoricoChamadas() {
      const chamadasArea = document.getElementById("chamadasArea");
      chamadasArea.style.display = "block";

      if (_histChamadasRef) _histChamadasRef.off();
      _histChamadasRef = db.ref("historicoChamadas");
      _histChamadasRef.on("value", snap => {
        const val = snap.val() || [];
        let lista = Array.isArray(val) ? val.filter(Boolean) : Object.values(val || {});
        lista = lista.slice(-8).reverse();
        const ul = document.getElementById("listaSenhasChamadas");
        ul.innerHTML = "";
        if (!lista.length) {
          ul.innerHTML = '<li style="opacity:.8;padding:8px">Nenhuma chamada registrada.</li>';
          return;
        }
        lista.forEach(item => {
          const li = document.createElement("li");
          const tipoLabel = item.tipo === "Agendar" ? "Agendar" : (item.tipo === "Agendados" ? "Realizar" : item.tipo || "");
          li.innerHTML = `<div class="left"><span class="senha">${item.senha}</span><span class="tipo">${tipoLabel}</span></div><div class="guiche">Guichê ${parseInt(item.guiche||0,10)}</div>`;
          ul.appendChild(li);
        });
      });
    }

    function chamarSenhaDireto(tipoSenha) {
      let guiche = String(document.getElementById('guicheNum').value || "").padStart(2, '0');
      historicoGuiche[guiche] = historicoGuiche[guiche] || {};
      document.querySelectorAll('.botao').forEach(btn => btn.disabled = true);

      db.ref("contadoresSenha/" + tipoSenha).transaction(function (currentValue) {
        if (currentValue === null || isNaN(currentValue)) currentValue = 0;
        return (currentValue + 1) % 1000;
      }, function(error, committed, snapshot) {
        document.querySelectorAll('.botao').forEach(btn => btn.disabled = false);
        if (error || !committed) {
          document.getElementById("msg").textContent = "Erro ao chamar senha, tente novamente!";
          return;
        }
        let contadorAtual = snapshot.val();
        let senhaStr = String(contadorAtual).padStart(3, '0');

        historicoGuiche[guiche][tipoSenha] = { senha: senhaStr, timestamp: Date.now() };

        db.ref(`ultimoPorGuiche/${guiche}/${tipoSenha}`).set({
          senha: senhaStr,
          timestamp: Date.now()
        });

        enviarSenha(tipoSenha, senhaStr, guiche, false);
        registrarAtendimento(tipoSenha, senhaStr, guiche);
      }, false);
    }

    function chamarSenha(tipoChamada) {
      let guiche = String(document.getElementById('guicheNum').value || "").padStart(2, '0');

      if (tipoChamada === 'repetir') {
        db.ref(`ultimoPorGuiche/${guiche}`).once('value').then(snap => {
          const val = snap.val() || {};
          const ag = val.Agendar;
          const agd = val.Agendados;
          if (!ag && !agd) {
            document.getElementById("msg").textContent = "Nenhuma senha para rechamar neste guichê!";
            return;
          }
          let escolhidoTipo = null;
          if (ag && agd) {
            escolhidoTipo = (ag.timestamp >= agd.timestamp) ? "Agendar" : "Agendados";
          } else if (ag) {
            escolhidoTipo = "Agendar";
          } else {
            escolhidoTipo = "Agendados";
          }

          const ultimoChamado = val[escolhidoTipo];
          if (!ultimoChamado || !ultimoChamado.senha) {
            document.getElementById("msg").textContent = "Nenhuma senha válida para rechamar neste guichê!";
            return;
          }
          enviarSenha(escolhidoTipo, ultimoChamado.senha, guiche, true);
          registrarAtendimento(escolhidoTipo, ultimoChamado.senha, guiche);
        }).catch(err=>{
          console.error(err);
          document.getElementById("msg").textContent = "Erro ao ler dados de rechamada. Tente novamente.";
        });
      }
    }

    function enviarSenha(tipo, senha, guiche, repetir) {
      document.getElementById("msg").textContent = `Chamando: ${tipo} - Senha ${senha} Guichê ${parseInt(guiche,10)}`;
      db.ref("chamadaSenha").set({
        tipo,
        senha,
        guiche,
        repetir: !!repetir,
        ts: Date.now()
      });
      db.ref("historicoChamadas").once("value", snap=>{
        let lista = snap.val() || [];
        if (!Array.isArray(lista)) lista = Object.values(lista || {});
        lista.push({tipo, senha, guiche, timestamp: Date.now()});
        if(lista.length>100) lista = lista.slice(-100);
        db.ref("historicoChamadas").set(lista);
      });
      db.ref(`ultimoPorGuiche/${guiche}/${tipo}`).set({
        senha,
        timestamp: Date.now()
      });
    }

    function contarAtendimentosValidos(lista) {
      if(!lista || lista.length === 0) return 0;
      lista.sort((a, b) => a.timestamp - b.timestamp);
      let count = 1;
      let ultimo = lista[0].timestamp;
      for(let i=1; i<lista.length; i++) {
        if(lista[i].timestamp - ultimo >= 60000) {
          count++;
          ultimo = lista[i].timestamp;
        }
      }
      return count;
    }

    // Funções de relatório/exportação/detalhes (restauradas)
    function exportarRelatorioExcelDetalhado(aba) {
      db.ref("atendimentos").once("value", snap => {
        const val = snap.val() || {};
        const agora = new Date();
        let workbook = XLSX.utils.book_new();

        let resumoDados = [["Usuário", "Atendimentos Dia", "Atendimentos Mês", "Atendimentos Ano"]];
        let totalDiaGeral = 0, totalMesGeral = 0, totalAnoGeral = 0;
        for (let usuario in val) {
          let atendimentos = Object.values(val[usuario]);
          if (!atendimentos.length) continue;
          let listaDia = atendimentos.filter(a=>{
            let d = new Date(a.timestamp);
            return d.toISOString().slice(0,10) === agora.toISOString().slice(0,10);
          });
          let listaMes = atendimentos.filter(a=>{
            let d = new Date(a.timestamp);
            return d.getMonth() === agora.getMonth() && d.getFullYear() === agora.getFullYear();
          });
          let listaAno = atendimentos.filter(a=>{
            let d = new Date(a.timestamp);
            return d.getFullYear() === agora.getFullYear();
          });
          let totalDia = contarAtendimentosValidos(listaDia);
          let totalMes = contarAtendimentosValidos(listaMes);
          let totalAno = contarAtendimentosValidos(listaAno);
          resumoDados.push([usuario, totalDia, totalMes, totalAno]);
          totalDiaGeral += totalDia;
          totalMesGeral += totalMes;
          totalAnoGeral += totalAno;
        }
        let wsResumo = XLSX.utils.aoa_to_sheet(resumoDados);
        XLSX.utils.book_append_sheet(workbook, wsResumo, "Resumo");
        let resumoTotal = [
          ["Atendimentos Dia", "Atendimentos Mês", "Atendimentos Ano"],
          [totalDiaGeral, totalMesGeral, totalAnoGeral]
        ];
        let wsTotal = XLSX.utils.aoa_to_sheet(resumoTotal);
        XLSX.utils.book_append_sheet(workbook, wsTotal, "Resumo Total");

        for (let usuario in val) {
          let atendimentos = Object.values(val[usuario]);
          if (!atendimentos.length) continue;
          let atendimentosFiltrados = atendimentos.filter(a => {
            let d = new Date(a.timestamp);
            if (aba==='dia') return d.toISOString().slice(0,10) === agora.toISOString().slice(0,10);
            if (aba==='mes') return d.getMonth() === agora.getMonth() && d.getFullYear() === agora.getFullYear();
            if (aba==='ano') return d.getFullYear() === agora.getFullYear();
            return true;
          });
          atendimentosFiltrados.sort((a,b)=>a.timestamp-b.timestamp);

          let listaDia = atendimentos.filter(a=>{
            let d = new Date(a.timestamp);
            return d.toISOString().slice(0,10) === agora.toISOString().slice(0,10);
          });
          let listaMes = atendimentos.filter(a=>{
            let d = new Date(a.timestamp);
            return d.getMonth() === agora.getMonth() && d.getFullYear() === agora.getFullYear();
          });
          let listaAno = atendimentos.filter(a=>{
            let d = new Date(a.timestamp);
            return d.getFullYear() === agora.getFullYear();
          });
          let totalDia = contarAtendimentosValidos(listaDia);
          let totalMes = contarAtendimentosValidos(listaMes);
          let totalAno = contarAtendimentosValidos(listaAno);

          let dados = [
            [`Total atendimentos Dia`, totalDia],
            [`Total atendimentos Mês`, totalMes],
            [`Total atendimentos Ano`, totalAno],
            [],
            ["Hora", "Tipo", "Senha", "Guichê", "Intervalo"]
          ];
          let prev = null;
          atendimentosFiltrados.forEach(a=>{
            let tempo = prev ? formatTempo(Math.round((a.timestamp-prev.timestamp)/1000)) : "--";
            dados.push([
              new Date(a.timestamp).toLocaleString(),
              a.tipo, a.senha, a.guiche, tempo
            ]);
            prev = a;
          });
          let ws = XLSX.utils.aoa_to_sheet(dados);
          XLSX.utils.book_append_sheet(workbook, ws, usuario.substring(0,31));
        }
        XLSX.writeFile(workbook, "relatorio_atendimentos.xlsx");
      });
    }

    function mostrarRelatorio(aba) {
      db.ref("atendimentos").once("value", snap => {
        const val = snap.val() || {};
        const agora = new Date();
        let html = `
          <div style="font-size:1.2em;margin-bottom:7px;font-weight:bold;">Relatório de Atendimentos</div>
          <button class="aba-btn ${aba==='dia'?'active':''}" onclick="mostrarRelatorio('dia')">Dia</button>
          <button class="aba-btn ${aba==='mes'?'active':''}" onclick="mostrarRelatorio('mes')">Mês</button>
          <button class="aba-btn ${aba==='ano'?'active':''}" onclick="mostrarRelatorio('ano')">Ano</button>
          <button class="excel-btn" onclick="exportarRelatorioExcelDetalhado('${aba}')">Exportar Excel</button>
          <button class="fechar-btn aba-btn" onclick="fecharRelatorio()">Fechar</button>
          <table class="relatorio-table">
            <tr>
              <th>Usuário</th>
              <th>Qtde</th>
              <th>Primeiro</th>
              <th>Último</th>
              <th>Média Tempo</th>
              <th>Detalhes</th>
            </tr>
        `;
        for (let usuario in val) {
          let atendimentos = Object.values(val[usuario]);
          if (!atendimentos.length) continue;
          let atendimentosFiltrados = atendimentos.filter(a => {
            let d = new Date(a.timestamp);
            if (aba==='dia') {
              return d.toISOString().slice(0,10) === agora.toISOString().slice(0,10);
            }
            if (aba==='mes') {
              return d.getMonth() === agora.getMonth() && d.getFullYear() === agora.getFullYear();
            }
            if (aba==='ano') {
              return d.getFullYear() === agora.getFullYear();
            }
            return true;
          });
          if (!atendimentosFiltrados.length) continue;
          let listaValidos = atendimentosFiltrados;
          let totalValidos = contarAtendimentosValidos(listaValidos);

          let tempos = [];
          atendimentosFiltrados.sort((a,b)=>a.timestamp-b.timestamp);
          for(let i=1; i<atendimentosFiltrados.length; i++) {
            tempos.push(atendimentosFiltrados[i].timestamp - atendimentosFiltrados[i-1].timestamp);
          }
          let mediaTempo = tempos.length ? formatTempo(Math.round(tempos.reduce((a,b)=>a+b,0)/tempos.length/1000)) : '--';
          let primeiro = new Date(atendimentosFiltrados[0].timestamp).toLocaleTimeString();
          let ultimo = new Date(atendimentosFiltrados[atendimentosFiltrados.length-1].timestamp).toLocaleTimeString();
          html += `<tr>
            <td>${usuario}</td>
            <td>${totalValidos}</td>
            <td>${primeiro}</td>
            <td>${ultimo}</td>
            <td>${mediaTempo}</td>
            <td>
              <button class="aba-btn" onclick="mostrarDetalhesUsuario('${usuario}','${aba}')">Ver</button>
            </td>
          </tr>`;
        }
        html += `</table>`;
        document.getElementById("relatorioArea").innerHTML = html;
      });
      document.getElementById("relatorioArea").style.display = "block";
    }

    window.mostrarDetalhesUsuario = function(usuario, aba) {
      db.ref("atendimentos/" + usuario).once("value", snap => {
        const val = Object.values(snap.val()||{});
        const agora = new Date();
        let atendimentosFiltrados = val.filter(a => {
          let d = new Date(a.timestamp);
          if (aba==='dia') {
            return d.toISOString().slice(0,10) === agora.toISOString().slice(0,10);
          }
          if (aba==='mes') {
            return d.getMonth() === agora.getMonth() && d.getFullYear() === agora.getFullYear();
          }
          if (aba==='ano') {
            return d.getFullYear() === agora.getFullYear();
          }
          return true;
        });
        atendimentosFiltrados.sort((a,b)=>a.timestamp-b.timestamp);
        let html = `<div><b>Detalhes de ${usuario} (${aba})</b><br>
          <button class="aba-btn" onclick="mostrarRelatorio('${aba}')">Voltar</button>
        <table class="relatorio-table">
          <tr>
            <th>Hora</th>
            <th>Tipo</th>
            <th>Senha</th>
            <th>Guichê</th>
            <th>Intervalo</th>
          </tr>`;
        let prev = null;
        atendimentosFiltrados.forEach((a,i)=>{
          let tempo = prev ? formatTempo(Math.round((a.timestamp-prev.timestamp)/1000)) : "--";
          html += `<tr>
            <td>${new Date(a.timestamp).toLocaleTimeString()}</td>
            <td>${a.tipo}</td>
            <td>${a.senha}</td>
            <td>${a.guiche}</td>
            <td>${tempo}</td>
          </tr>`;
          prev = a;
        });
        html += `</table></div>`;
        document.getElementById("relatorioArea").innerHTML = html;
      });
    }

    // funções admin / CRUD / demais (permanece igual)
    function adicionarUsuarioAutorizado() {
      const novoUsuario = document.getElementById("novoUsuario").value.trim();
      if (!novoUsuario) return;
      if (!usuariosAutorizados.includes(novoUsuario)) {
        usuariosAutorizados.push(novoUsuario);
        db.ref("usuariosAutorizados").set(usuariosAutorizados);
        document.getElementById("msgAdmin").textContent = "Usuário autorizado!";
        mostrarCamposAdmin();
      } else {
        document.getElementById("msgAdmin").textContent = "Usuário já está autorizado!";
      }
    }

    function removerUsuarioAutorizado(u) {
      usuariosAutorizados = usuariosAutorizados.filter(user => user !== u);
      db.ref("usuariosAutorizados").set(usuariosAutorizados);
      mostrarCamposAdmin();
    }

    function registrarAtendimento(tipo, senha, guiche) {
      if (!usuarioLogado) return;
      const now = new Date();
      const dataHoje = now.toISOString().slice(0,10);
      const registro = {
        timestamp: now.getTime(),
        tipo,
        senha,
        guiche,
        data: dataHoje,
      };
      db.ref("atendimentos/" + usuarioLogado).push(registro);
    }

    function abrirAdmin() {
      const adminDiv = document.getElementById("adminArea");
      if (!isAdmin) {
        adminDiv.innerHTML = `
          <div style="color:red;">Acesso restrito ao administrador!</div>
          <button class="fechar-btn botao" onclick="fecharAdmin()">Fechar</button>
        `;
        adminDiv.style.display = "block";
        return;
      }
      mostrarCamposAdmin();
      adminDiv.style.display = "block";
    }

    function fecharAdmin() {
      document.getElementById("adminArea").style.display = "none";
    }

    function limparAtendimentos() {
      if (confirm("Tem certeza que deseja apagar TODOS os atendimentos registrados? Esta ação não pode ser desfeita.")) {
        db.ref("atendimentos").set(null, (err)=>{
          document.getElementById("msgAdmin").textContent = err ? "Erro ao limpar!" : "Dados de atendimentos apagados!";
        });
      }
    }

    function mostrarCamposAdmin() {
      db.ref("contadoresSenha").once("value", snap => {
        const val = snap.val() || {Agendar: 0, Agendados: 0};
        const adminDiv = document.getElementById("adminArea");
        let usuariosHtml = "<ul>";
        usuariosAutorizados.forEach(u => {
          usuariosHtml += `<li>${u} <button onclick="removerUsuarioAutorizado('${u}')" style="background:#ff4040;color:#fff;border:none;border-radius:5px;padding:2px 7px;cursor:pointer;">Remover</button></li>`;
        });
        usuariosHtml += "</ul>";
        adminDiv.innerHTML = `
          <div style="margin-bottom:12px;font-size:1.2em;font-weight:bold;color:#ffe900;">Ajuste dos Contadores</div>
          <label for="novoAgendar">Agendar: </label>
          <input type="number" id="novoAgendar" min="0" max="999" value="${val.Agendar}">
          <br>
          <label for="novoAgendados">Agendados: </label>
          <input type="number" id="novoAgendados" min="0" max="999" value="${val.Agendados}">
          <br>
          <button class="botao" onclick="atualizarContadores()">Atualizar</button>
          <div style="margin:14px 0; border-top:1px solid #ffe90033"></div>
          <div style="margin-bottom:10px;font-weight:bold;color:#ffe900;">Usuários autorizados</div>
          ${usuariosHtml}
          <input type="text" id="novoUsuario" placeholder="Novo usuário">
          <button class="botao" onclick="adicionarUsuarioAutorizado()">Adicionar</button>
          <button class="limpar-btn botao" onclick="limparAtendimentos()">Limpar Dados</button>
          <button class="fechar-btn botao" onclick="fecharAdmin()">Fechar</button>
          <div id="msgAdmin" class="msg-admin"></div>
        `;
      });
    }

    function atualizarContadores() {
      let novoAgendar = parseInt(document.getElementById("novoAgendar").value,10);
      let novoAgendados = parseInt(document.getElementById("novoAgendados").value,10);
      if (isNaN(novoAgendar) || novoAgendar < 0 || novoAgendar > 999 ||
          isNaN(novoAgendados) || novoAgendados < 0 || novoAgendados > 999) {
        document.getElementById("msgAdmin").textContent = "Digite números válidos entre 0 e 999.";
        return;
      }
      contadores.Agendar = novoAgendar;
      contadores.Agendados = novoAgendados;
      db.ref("contadoresSenha").set(contadores, (err)=>{
        document.getElementById("msgAdmin").textContent = err ? "Erro ao atualizar!" : "Contadores atualizados com sucesso!";
      });
    }

    function abrirRelatorio() {
      if (!isAdmin) {
        document.getElementById("relatorioArea").innerHTML = `<div style="color:red;">Acesso restrito ao administrador!</div>`;
        document.getElementById("relatorioArea").style.display = "block";
        return;
      }
      mostrarRelatorio('dia');
    }

    function fecharRelatorio() {
      document.getElementById("relatorioArea").style.display = "none";
    }

    function formatTempo(segundos) {
      if (segundos < 60) return segundos + "s";
      if (segundos < 3600) return (segundos/60).toFixed(1) + "min";
      return (segundos/3600).toFixed(2) + "h";
    }

    function toggleSenhaVisivel() {
      let input = document.getElementById("senha");
      input.type = input.type === "password" ? "text" : "password";
    }

    // Enter faz login
    document.getElementById("senha").addEventListener("keyup",function(e){
      if(e.key === "Enter"){ checarLogin(); }
    });
    document.getElementById("usuario").addEventListener("keyup",function(e){
      if(e.key === "Enter"){ checarLogin(); }
    });
  </script>
</body>
</html>
