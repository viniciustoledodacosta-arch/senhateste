<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Guichê - Painel de Senhas</title>
  <style>
    :root {
      --verde-hcpa: #276e5b;
      --amarelo-hcpa: #ffe900;
      --preto: #000;
      --cinza-texto: #fffbe5;
    }
    body {
      background: var(--verde-hcpa);
      color: var(--amarelo-hcpa);
      font-family: Arial, Helvetica, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: var(--preto);
      border-radius: 15px;
      padding: 36px 40px;
      box-shadow: 0 0 12px #0007;
      text-align: center;
      min-width: 350px;
      max-width: 650px;
      margin: auto;
    }
    .titulo {
      font-size: 2.2em;
      color: var(--amarelo-hcpa);
      margin-bottom: 18px;
      font-weight: bold;
      letter-spacing: 1px;
    }
    label, input, select { font-size: 1.2em; margin: 4px 0; }
    input, select {
      padding: 6px;
      border-radius: 6px;
      border: none;
      margin-bottom: 14px;
      width: 80%;
      box-sizing: border-box;
    }
    .botao {
      background: var(--amarelo-hcpa);
      color: var(--preto);
      border: none;
      border-radius: 8px;
      font-size: 1.25em;
      padding: 12px 24px;
      margin: 10px 8px 10px 0;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .botao:hover { background: #fffbe5; }
    .senha-form { margin-bottom: 22px; }
    .admin-btn {
      margin-top: 24px;
      background: #2196F3;
      color: #fff;
      font-weight: bold;
      border-radius: 8px;
      padding: 8px 22px;
      border: none;
      cursor: pointer;
      font-size: 1.1em;
      transition: background 0.2s;
    }
    .admin-btn:hover { background: #1565c0; }
    .admin-area {
      background: #222;
      border-radius: 10px;
      padding: 24px 22px;
      color: #ffe900;
      font-size: 1.15em;
      box-shadow: 0 0 8px #0004;
      margin-top: 18px;
      display: none;
      text-align: left;
      margin-left: auto;
      margin-right: auto;
      max-width: 420px;
    }
    .admin-area label {
      display: block;
      margin-bottom: 7px;
      font-weight: bold;
      font-size: 1.2em;
    }
    .admin-area input[type="number"] {
      width: 110px;
      margin-bottom: 12px;
      font-size: 1.15em;
      padding: 5px;
    }
    .admin-area .botao {
      margin-top: 10px;
      background: #0074d9;
      color: #fff;
      font-size: 1.15em;
    }
    .admin-area .botao:hover {
      background: #004b8a;
    }
    .admin-area .fechar-btn {
      background: #ff4040;
      color: #fff;
      font-size: 1em;
      margin-left: 12px;
    }
    .admin-area .fechar-btn:hover {
      background: #a90000;
    }
    .admin-area .msg-admin {
      margin-top: 18px;
      color: #fffbe5;
      font-size: 1em;
      font-weight: bold;
    }
    .admin-area .limpar-btn {
      background: #ff9800;
      color: #fff;
      margin-top: 14px;
      margin-left: 0;
      font-size: 1.1em;
      border-radius: 8px;
      padding: 8px 18px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .admin-area .limpar-btn:hover {
      background: #b36a00;
    }
    .relatorio-area {
      background: #222;
      border-radius: 10px;
      padding: 22px;
      color: #ffe900;
      font-size: 1.03em;
      margin-top: 14px;
      box-shadow: 0 0 8px #0004;
      display: none;
      max-width: 600px;
      overflow-x: auto;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    .relatorio-table th, .relatorio-table td {
      padding: 7px 11px;
      border-bottom: 1px solid #ffe90044;
      text-align: center;
    }
    .relatorio-table th {
      background: #276e5b;
      color: #ffe900;
      font-weight: bold;
    }
    .relatorio-table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    .aba-btn {
      background: #276e5b;
      color: #ffe900;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 8px;
      margin-bottom: 9px;
      transition: background 0.2s;
    }
    .aba-btn.active { background: #ffe900; color: #276e5b; }
    .excel-btn {
      background: #4caf50;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 18px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 8px;
      margin-bottom: 9px;
      font-size: 1em;
      transition: background 0.2s;
    }
    .excel-btn:hover { background: #1b5e20; }
    /* --- HISTÓRICO MINI PAINEL ADICIONAL --- */
    .painel-historico {
      background: var(--preto);
      border-radius: 12px;
      min-width: 240px;
      max-width: 260px;
      color: var(--amarelo-hcpa);
      padding: 18px 18px 14px 18px;
      font-size: 1em;
      height: 370px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 0 10px #0007;
      position: fixed;
      right: 40px;
      top: 50px;
      z-index: 99;
      display: none;
    }
    .painel-historico-titulo {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--amarelo-hcpa);
      margin-bottom: 10px;
      text-align: left;
      width: 100%;
      letter-spacing: 0.03em;
    }
    .painel-historico-lista {
      width: 100%;
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      flex: 1;
      max-height: 310px;
    }
    .painel-historico-lista li {
      border-bottom: 1px solid #ffe90033;
      padding: 5px 0;
      font-size: 1.07em;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      word-break: break-word;
    }
    .painel-historico-li-top { font-weight: bold; margin-bottom: 1px; }
    .painel-historico-li-bottom { font-size: 0.95em; color: #ffe900cc; }
    @media (max-width: 950px){
      .painel-historico{position:static;margin: 20px auto;}
    }
    @media (max-width: 700px) {
      .container, .admin-area, .relatorio-area { min-width: 95vw; max-width: 97vw; padding-left: 4vw; padding-right: 4vw;}
      .painel-historico { min-width: 90vw; max-width: 98vw; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container" id="guiche-container" style="display:none;">
    <div class="titulo">Guichê</div>
    <div id="usuarioLogado" style="color:#fffbe5;margin-bottom:12px;font-size:1.1em;"></div>
    <label for="guicheNum">Número do Guichê:</label>
    <input type="number" id="guicheNum" min="1" max="20" value="1" required><br>
    <button class="botao" onclick="chamarSenhaDireto('Agendar')">Senha Agendar</button>
    <button class="botao" onclick="chamarSenhaDireto('Agendados')">Senha Realizar</button>
    <button class="botao" onclick="chamarSenha('repetir')">Rechamar</button>
    <div id="msg" style="color:yellow;margin-top:10px;"></div>
    <button class="admin-btn" onclick="abrirAdmin()">Administração</button>
    <button class="admin-btn" onclick="abrirRelatorio()">Relatórios</button>
    <div id="adminArea" class="admin-area"></div>
    <div id="relatorioArea" class="relatorio-area"></div>
  </div>
  <!-- ALTERAÇÃO LOGIN: Olho + Enter -->
  <div id="senha-protect" class="senha-form">
    <label for="usuario">Usuário:</label>
    <input type="text" id="usuario" autofocus>
    <br>
    <label for="senha">Senha de acesso:</label>
    <div style="position:relative;width:220px;display:inline-block;">
      <input type="password" id="senha" style="width:220px;padding-right:36px;">
      <button id="senha-eye" type="button" tabindex="-1" onclick="toggleSenhaVisivel()" aria-label="Mostrar ou ocultar senha" style="position:absolute;right:4px;top:6px;background:none;border:none;color:#ffe900;font-size:1.3em;cursor:pointer;outline:none;">&#128065;</button>
    </div>
    <button onclick="checarLogin()" style="margin-top:10px;">Entrar</button>
    <div id="msgSenha" style="color:red;margin-top:8px;"></div>
  </div>
  <!-- MINI PAINEL HISTÓRICO -->
  <div class="painel-historico" id="painelHistorico">
    <div class="painel-historico-titulo">Senhas Chamadas</div>
    <ul class="painel-historico-lista" id="painelHistoricoLista"></ul>
  </div>
  <script>
    // OLHO SENHA
    function toggleSenhaVisivel() {
      let input = document.getElementById("senha");
      input.type = input.type === "password" ? "text" : "password";
    }
    // ENTER para login
    document.getElementById("senha").addEventListener("keyup",function(e){
      if(e.key === "Enter"){ checarLogin(); }
    });
    document.getElementById("usuario").addEventListener("keyup",function(e){
      if(e.key === "Enter"){ checarLogin(); }
    });

    // MINI PAINEL HISTÓRICO EM TEMPO REAL
    function atualizarMiniHistorico(){
      if(!window.usuarioLogado) return;
      // Remove listener anterior se já existir
      if(window._miniHistRef && window._miniHistCb){
        window._miniHistRef.off("value", window._miniHistCb);
      }
      window._miniHistRef = db.ref("atendimentos/"+window.usuarioLogado).orderByChild("timestamp").limitToLast(6);
      window._miniHistCb = function(snap){
        const val = snap.val();
        let lista = val ? Object.values(val).sort((a, b) => b.timestamp - a.timestamp) : [];
        lista = lista.slice(0,6);
        const ul = document.getElementById("painelHistoricoLista");
        ul.innerHTML = "";
        if (!lista.length) {
          ul.innerHTML = `<li style="opacity:.8;">Nenhuma senha chamada ainda.</li>`;
          return;
        }
        lista.forEach(item => {
          let tipoStr = item.tipo === "Agendar" ? "Agendar" : "Realizar";
          let data = new Date(item.timestamp);
          let hora = data.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          let linha = `<span class="painel-historico-li-top">${tipoStr} &ndash; Senha <b>${item.senha}</b> &ndash; Guichê ${parseInt(item.guiche,10)}</span>
                        <span class="painel-historico-li-bottom">${hora}</span>`;
          let li = document.createElement("li");
          li.innerHTML = linha;
          ul.appendChild(li);
        });
      };
      window._miniHistRef.on("value", window._miniHistCb);
      document.getElementById("painelHistorico").style.display = "flex";
    }

    // Após login, mostrar painel histórico e atualizar
    const _checarLoginOrig = checarLogin;
    checarLogin = function(){
      _checarLoginOrig();
      setTimeout(()=>{
        if(window.usuarioLogado){
          document.getElementById("painelHistorico").style.display = "flex";
          atualizarMiniHistorico();
        }
      },0);
    };
  </script>
  <!--
    Seu <script> original começa aqui e está 100% preservado.
    O código acima apenas ADICIONA funcionalidades.
  -->
  <script>
    // ... (TODO O SEU SCRIPT ORIGINAL)
  </script>
</body>
</html>
