<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Guichê - Painel de Senhas</title>
  <style>
    :root {
      --verde-hcpa: #276e5b;
      --amarelo-hcpa: #ffe900;
      --preto: #000;
      --cinza-texto: #fffbe5;
    }
    html, body {
      background: var(--verde-hcpa);
      color: var(--amarelo-hcpa);
      font-family: Arial, Helvetica, sans-serif;
      height: 100vh;
      margin: 0;
      width: 100vw;
      min-height: 100vh;
      min-width: 100vw;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      min-width: 100vw;
    }
    .main-flex {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
      max-width: 1200px;
      min-height: 100vh;
    }
    .container {
      background: var(--preto);
      border-radius: 15px;
      padding: 36px 40px;
      box-shadow: 0 0 12px #0007;
      text-align: center;
      min-width: 350px;
      max-width: 650px;
      margin: 50px 0 50px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .titulo {
      font-size: 2.2em;
      color: var(--amarelo-hcpa);
      margin-bottom: 18px;
      font-weight: bold;
      letter-spacing: 1px;
    }
    label, input, select { font-size: 1.2em; margin: 4px 0; }
    input, select {
      padding: 6px;
      border-radius: 6px;
      border: none;
      margin-bottom: 14px;
      width: 80%;
      box-sizing: border-box;
    }
    .botao {
      background: var(--amarelo-hcpa);
      color: var(--preto);
      border: none;
      border-radius: 8px;
      font-size: 1.25em;
      padding: 12px 24px;
      margin: 10px 8px 10px 0;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .botao:hover { background: #fffbe5; }
    .senha-form {
      margin-bottom: 22px;
      background: var(--preto);
      border-radius: 18px;
      box-shadow: 0 0 20px #0004;
      padding: 38px 38px 28px 38px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 350px;
      max-width: 400px;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .senha-form label { color: var(--amarelo-hcpa); margin-bottom: 0; }
    .senha-form input[type=text], .senha-form input[type=password] {
      width: 220px; max-width: 90vw;
      font-size: 1.17em;
    }
    .senha-wrapper {
      position: relative;
      width: 220px;
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    #senha-eye {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25em;
      color: #ffe900;
      outline: none;
      z-index: 2;
      padding: 2px 4px;
      height: 32px;
      width: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* MINI HISTÓRICO */
    .painel-historico {
      background: var(--preto);
      border-radius: 12px;
      margin-left: 32px;
      min-width: 220px;
      max-width: 250px;
      color: var(--amarelo-hcpa);
      padding: 18px 12px 12px 18px;
      font-size: 1em;
      height: 370px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 0 10px #0007;
      margin-top: 50px;
      overflow: hidden;
    }
    .painel-historico-titulo {
      font-size: 1.25em;
      font-weight: bold;
      color: var(--amarelo-hcpa);
      margin-bottom: 12px;
      text-align: left;
      width: 100%;
      letter-spacing: 0.03em;
    }
    .painel-historico-lista {
      width: 100%;
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      flex: 1;
      max-height: 310px;
    }
    .painel-historico-lista li {
      border-bottom: 1px solid #ffe90033;
      padding: 5px 0;
      font-size: 1.07em;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      word-break: break-word;
    }
    .painel-historico-li-top {
      font-weight: bold;
      margin-bottom: 1px;
    }
    .painel-historico-li-bottom {
      font-size: 0.95em;
      color: #ffe900cc;
    }
    @media (max-width: 700px) {
      .container, .admin-area, .relatorio-area, .senha-form { min-width: 95vw; max-width: 97vw; padding-left: 4vw; padding-right: 4vw;}
      .painel-historico { min-width: 90vw; max-width: 98vw; }
      #senha-eye { right: 4vw;}
      .senha-wrapper { width: 98vw; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="main-flex" style="width:100%;">
    <div class="container" id="guiche-container" style="display:none;">
      <div class="titulo">Guichê</div>
      <div id="usuarioLogado" style="color:#fffbe5;margin-bottom:12px;font-size:1.1em;"></div>
      <label for="guicheNum">Número do Guichê:</label>
      <input type="number" id="guicheNum" min="1" max="20" value="1" required><br>
      <button class="botao" onclick="chamarSenhaDireto('Agendar')">Senha Agendar</button>
      <button class="botao" onclick="chamarSenhaDireto('Agendados')">Senha Realizar</button>
      <button class="botao" onclick="chamarSenha('repetir')">Rechamar</button>
      <div id="msg" style="color:yellow;margin-top:10px;"></div>
      <button class="admin-btn" onclick="abrirAdmin()">Administração</button>
      <button class="admin-btn" onclick="abrirRelatorio()">Relatórios</button>
      <div id="adminArea" class="admin-area"></div>
      <div id="relatorioArea" class="relatorio-area"></div>
    </div>
    <div class="painel-historico" id="painelHistorico" style="display:none;">
      <div class="painel-historico-titulo">Senhas Chamadas</div>
      <ul class="painel-historico-lista" id="painelHistoricoLista"></ul>
    </div>
  </div>
  <form id="form-login" class="senha-form">
    <label for="usuario">Usuário:</label>
    <input type="text" id="usuario" autocomplete="username" autofocus>
    <br>
    <label for="senha">Senha de acesso:</label>
    <div class="senha-wrapper">
      <input type="password" id="senha" autocomplete="current-password">
      <button id="senha-eye" type="button" tabindex="-1" onclick="toggleSenhaVisivel()" aria-label="Mostrar ou ocultar senha">&#128065;</button>
    </div>
    <button type="submit" style="margin-top:12px;">Entrar</button>
    <div id="msgSenha" style="color:red;margin-top:8px;"></div>
  </form>
  <script>
    // === LOGIN COM ENTER E OLHO ===
    document.getElementById('form-login').addEventListener('submit', function(e){
      e.preventDefault();
      checarLogin();
    });
    function toggleSenhaVisivel() {
      let input = document.getElementById("senha");
      if(input.type === "password") {
        input.type = "text";
      } else {
        input.type = "password";
      }
    }

    // --- CÓDIGO PADRÃO DO SISTEMA ---
    const senhaCorreta = "radiologia2025";
    const usuarioAdmin = "vtcosta";
    const senhaAdmin = "admtoledo";

    let usuariosAutorizados = [];
    let usuarioLogado = null;
    let isAdmin = false;

    const firebaseConfig = {
      apiKey: "AIzaSyB-wxIiE1o4SlwhIAowvzDoP2MTCwHeUA8",
      authDomain: "senha-teste-3792a.firebaseapp.com",
      databaseURL: "https://senha-teste-3792a-default-rtdb.firebaseio.com",
      projectId: "senha-teste-3792a",
      storageBucket: "senha-teste-3792a.appspot.com",
      messagingSenderId: "748802844835",
      appId: "1:748802844835:web:443305d871158d21ab7716",
      measurementId: "G-P6PCN541CD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref("usuariosAutorizados").on("value", snap => {
      usuariosAutorizados = snap.val() || [];
    });

    let contadores = {
      Agendar: 0,
      Agendados: 0
    };
    let historicoGuiche = {};

    db.ref("contadoresSenha").once("value", snap => {
      const val = snap.val();
      if(val) contadores = val;
    });

    function checarLogin() {
      const usuario = document.getElementById("usuario").value.trim();
      const senhaInput = document.getElementById("senha").value;
      let msg = document.getElementById("msgSenha");

      // Admin
      if (usuario === usuarioAdmin && senhaInput === senhaAdmin) {
        usuarioLogado = usuarioAdmin;
        isAdmin = true;
        document.getElementById("form-login").style.display = "none";
        document.getElementById("guiche-container").style.display = "block";
        document.getElementById("painelHistorico").style.display = "block";
        document.getElementById("usuarioLogado").textContent = "Usuário admin: " + usuarioLogado;
        atualizarMiniHistorico();
        return;
      }
      // Usuário comum
      if (usuariosAutorizados.includes(usuario) && senhaInput === senhaCorreta) {
        usuarioLogado = usuario;
        isAdmin = false;
        document.getElementById("form-login").style.display = "none";
        document.getElementById("guiche-container").style.display = "block";
        document.getElementById("painelHistorico").style.display = "block";
        document.getElementById("usuarioLogado").textContent = "Usuário: " + usuarioLogado;
        atualizarMiniHistorico();
        return;
      }
      msg.textContent = "Usuário ou senha incorretos!";
    }

    function chamarSenhaDireto(tipoSenha) {
      let guiche = document.getElementById('guicheNum').value.padStart(2, '0');
      historicoGuiche[guiche] = historicoGuiche[guiche] || {};
      document.querySelectorAll('.botao').forEach(btn => btn.disabled = true);

      db.ref("contadoresSenha/" + tipoSenha).transaction(function (currentValue) {
        if (currentValue === null || isNaN(currentValue)) currentValue = 0;
        return (currentValue + 1) % 1000;
      }, function(error, committed, snapshot) {
        document.querySelectorAll('.botao').forEach(btn => btn.disabled = false);
        if (error || !committed) {
          document.getElementById("msg").textContent = "Erro ao chamar senha, tente novamente!";
          return;
        }
        let senhaAtual = snapshot.val();
        let senhaStr = String(senhaAtual === 0 ? 999 : senhaAtual - 1).padStart(3, '0');
        if (senhaAtual === 0) senhaStr = "999";
        historicoGuiche[guiche][tipoSenha] = { senha: senhaStr, timestamp: Date.now() };
        enviarSenha(tipoSenha, senhaStr, guiche, false);
        registrarAtendimento(tipoSenha, senhaStr, guiche);
        atualizarMiniHistorico();
      }, false);
    }

    function chamarSenha(tipoChamada) {
      let guiche = document.getElementById('guicheNum').value.padStart(2, '0');
      let tipoSenha = null;
      if (tipoChamada === 'repetir') {
        if (historicoGuiche[guiche] && historicoGuiche[guiche]["Agendados"]) {
          tipoSenha = "Agendados";
        } else if (historicoGuiche[guiche] && historicoGuiche[guiche]["Agendar"]) {
          tipoSenha = "Agendar";
        }
        if (tipoSenha) {
          let ultimoChamado = historicoGuiche[guiche][tipoSenha];
          enviarSenha(tipoSenha, ultimoChamado.senha, guiche, true);
          registrarAtendimento(tipoSenha, ultimoChamado.senha, guiche);
          atualizarMiniHistorico();
        } else {
          document.getElementById("msg").textContent = "Nenhuma senha para rechamar neste guichê!";
        }
      }
    }

    function enviarSenha(tipo, senha, guiche, repetir) {
      document.getElementById("msg").textContent = `Chamando: ${tipo} - Senha ${senha} Guichê ${parseInt(guiche,10)}`;
      db.ref("chamadaSenha").set({
        tipo,
        senha,
        guiche,
        repetir: !!repetir, // true para rechamada, false para chamada normal
        ts: Date.now()      // timestamp para garantir mudança sempre
      });
      db.ref("historicoChamadas").once("value", snap=>{
        let lista = snap.val() || [];
        lista.push({tipo, senha, guiche, timestamp: Date.now()});
        if(lista.length>10) lista = lista.slice(-10);
        db.ref("historicoChamadas").set(lista);
      });
    }

    // MINI PAINEL DE HISTÓRICO DE SENHAS CHAMADAS (ULTIMAS 6)
    function atualizarMiniHistorico() {
      if (!usuarioLogado) return;
      // Atualiza em tempo real!
      if(window._miniHistRef) window._miniHistRef.off();
      window._miniHistRef = db.ref("atendimentos/" + usuarioLogado).orderByChild("timestamp").limitToLast(6);
      window._miniHistRef.on("value", snap => {
        const val = snap.val();
        let lista = val ? Object.values(val).sort((a, b) => b.timestamp - a.timestamp) : [];
        lista = lista.slice(-6).reverse();
        const ul = document.getElementById("painelHistoricoLista");
        ul.innerHTML = "";
        if (!lista.length) {
          ul.innerHTML = `<li style="opacity:.8;">Nenhuma senha chamada ainda.</li>`;
          return;
        }
        lista.forEach(item => {
          let tipoStr = item.tipo === "Agendar" ? "Agendar" : "Realizar";
          let data = new Date(item.timestamp);
          let hora = data.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          let linha = `<span class="painel-historico-li-top">${tipoStr} &ndash; Senha <b>${item.senha}</b> &ndash; Guichê ${parseInt(item.guiche,10)}</span>
                        <span class="painel-historico-li-bottom">${hora}</span>`;
          let li = document.createElement("li");
          li.innerHTML = linha;
          ul.appendChild(li);
        });
      });
    }

    // ...restante do código igual...
    // (não altere funções de relatório, administração, etc)
  </script>
</body>
</html>
